#!/bin/bash

# --- –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Neovim –≤ Docker —Å –∞–≤—Ç–æ—Å–±–æ—Ä–∫–æ–π ---

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
IMAGE_NAME="my-dev-nvim"
# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –≥–¥–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ª–µ–∂–∏—Ç –Ω–∞—à Dockerfile
BUILD_CONTEXT="$PWD"
DOCKERFILE_PATH="$BUILD_CONTEXT/Dockerfile"

# --- 1. –ü–†–û–í–ï–†–ö–ê –ò –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ Docker-–æ–±—Ä–∞–∑–∞ '$IMAGE_NAME'..."
IMAGE_ID=$(docker images -q "$IMAGE_NAME")
if [ -z "$IMAGE_ID" ]; then
    echo "‚ö†Ô∏è  –û–±—Ä–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–±–æ—Ä–∫–∞."
    if [ ! -f "$DOCKERFILE_PATH" ]; then
        echo -e "\n‚ùå –û—à–∏–±–∫–∞: Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $DOCKERFILE_PATH"
        exit 1
    fi
    echo -e "\nüîß –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä–∫—É –æ–±—Ä–∞–∑–∞..."
    docker build -t "$IMAGE_NAME" "$BUILD_CONTEXT"
    if [ $? -ne 0 ]; then
        echo -e "\n‚ùå –û—à–∏–±–∫–∞: –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å."
        exit 1
    else
        echo -e "\n‚úÖ –û–±—Ä–∞–∑ '$IMAGE_NAME' —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω."
    fi
else
    echo "‚úÖ –û–±—Ä–∞–∑ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é —Å–±–æ—Ä–∫—É."
fi

# --- 2. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–£–¢–ò –ö –ü–†–û–ï–ö–¢–£ –ò –ó–ê–ü–£–°–ö ---
# --------------------------------------------------
echo -e "\nüöÄ  **–ó–∞–ø—É—Å–∫ Neovim –≤ Docker**\n"

# ===== –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ =====
# –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç—É –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç (–ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
if [ -n "$1" ]; then
    TARGET_PATH="$1"
    echo "üìÇ –£–∫–∞–∑–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: $TARGET_PATH"
else
    # –ò–Ω–∞—á–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
    TARGET_PATH="$PWD"
    echo "üìÇ –ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–∞–∫ –ø—Ä–æ–µ–∫—Ç: $TARGET_PATH"
fi

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π, —á—Ç–æ–±—ã Docker –µ–≥–æ —Ç–æ—á–Ω–æ –ø–æ–Ω—è–ª.
# –≠—Ç–æ —Ç–∞–∫–∂–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
PROJECT_PATH_ABSOLUTE=$(realpath "$TARGET_PATH" 2>/dev/null)

if [ -z "$PROJECT_PATH_ABSOLUTE" ]; then
    echo -e "\n‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ '$TARGET_PATH'. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    exit 1
fi

echo -e "\n–ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
sleep 1

docker run -it --rm \
    -v "$PROJECT_PATH_ABSOLUTE:/home/dev/project" \
    -v "$BUILD_CONTEXT/config/nvim:/home/dev/.config/nvim" \
    -v "$BUILD_CONTEXT/local/share/nvim:/home/dev/.local/share/nvim" \
    -v "$BUILD_CONTEXT/local/state/nvim:/home/dev/.local/state/nvim" \
    -v "$BUILD_CONTEXT/cache/nvim:/home/dev/.cache/nvim" \
    "$IMAGE_NAME" nvim /home/dev/project

echo -e "\n‚úÖ  **–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.**\n"